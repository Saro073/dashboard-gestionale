<!DOCTYPE html>
<html>
<head>
    <title>Security Fixes Test</title>
    <style>
        body { font-family: monospace; margin: 20px; line-height: 1.6; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .test { margin-bottom: 20px; padding: 10px; border-left: 3px solid #ccc; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ðŸ”’ Security Fixes Verification Test</h1>
    <p>This page tests the security fixes applied to the dashboard.</p>

    <div id="results"></div>

    <script src="js/security/hash.js"></script>
    <script src="js/security/sanitizer.js"></script>
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth/users.js"></script>
    <script src="js/auth/auth.js"></script>

    <script>
        const results = document.getElementById('results');
        
        function addTest(name, passed, details) {
            const div = document.createElement('div');
            div.className = 'test';
            div.innerHTML = `
                <span class="${passed ? 'pass' : 'fail'}">${passed ? 'âœ“' : 'âœ—'} ${name}</span>
                <pre>${details}</pre>
            `;
            results.appendChild(div);
        }

        try {
            // TEST 1: PasswordHash
            console.log('Testing PasswordHash...');
            const testPass = 'MySecurePass123!';
            const hashed = PasswordHash.hash(testPass);
            const verified = PasswordHash.verify(testPass, hashed);
            const wrongVerified = PasswordHash.verify('WrongPassword', hashed);
            
            addTest(
                'PasswordHash: Hash & Verify',
                verified && !wrongVerified,
                `Correct password verified: ${verified}
Wrong password rejected: ${!wrongVerified}
Hash starts with 'hash_v1_': ${hashed.startsWith('hash_v1_')}`
            );

            // TEST 2: Sanitizer
            console.log('Testing Sanitizer...');
            const xssPayload = '<script>alert("xss")<' + '/script>';
            const sanitized = Sanitizer.escapeHtml(xssPayload);
            const isEscaped = !sanitized.includes('<script>');
            
            addTest(
                'Sanitizer: XSS Prevention',
                isEscaped,
                `Input: ${xssPayload}
Output: ${sanitized}
Contains escaped tags: ${sanitized.includes('&lt;')}`
            );

            // TEST 3: User creation with hashing
            console.log('Testing user creation...');
            StorageManager.remove(CONFIG.STORAGE_KEYS.USERS);
            UserManager.init();
            
            const userResult = UserManager.create({
                username: 'testadmin',
                password: 'AdminPass123!',
                fullName: 'Test Admin',
                email: 'admin@test.com',
                role: CONFIG.ROLES.ADMIN
            });

            const userCreated = userResult.success;
            const passwordHashed = userResult.user.password.startsWith('hash_v1_');
            const passwordNotPlaintext = userResult.user.password !== 'AdminPass123!';

            addTest(
                'User Creation: Password Hashing',
                userCreated && passwordHashed && passwordNotPlaintext,
                `User created: ${userCreated}
Password is hashed: ${passwordHashed}
Password is NOT plaintext: ${passwordNotPlaintext}
Stored password: ${userResult.user.password.substring(0, 30)}...`
            );

            // TEST 4: Login verification
            console.log('Testing login...');
            AuthManager.init();
            const loginResult = AuthManager.login('testadmin', 'AdminPass123!');
            const loginSuccess = loginResult.success;
            const userLoaded = loginResult.user.username === 'testadmin';

            addTest(
                'Login: Password Verification',
                loginSuccess && userLoaded,
                `Login successful: ${loginSuccess}
Current user: ${loginResult.user.username}
User is authenticated: ${AuthManager.isAuthenticated()}`
            );

            // TEST 5: Wrong password rejected
            console.log('Testing wrong password...');
            const wrongLoginResult = AuthManager.login('testadmin', 'WrongPassword123!');
            const wrongPasswordRejected = !wrongLoginResult.success;

            addTest(
                'Login: Wrong Password Rejection',
                wrongPasswordRejected,
                `Wrong password rejected: ${wrongPasswordRejected}
Error message: ${wrongLoginResult.message}`
            );

            // TEST 6: No hardcoded admin credentials
            console.log('Testing hardcoded credentials...');
            StorageManager.remove(CONFIG.STORAGE_KEYS.USERS);
            UserManager.init();
            const usersAfterInit = UserManager.getAll();
            const noHardcodedAdmin = usersAfterInit.length === 0;

            addTest(
                'Security: No Hardcoded Admin',
                noHardcodedAdmin,
                `Users after init: ${usersAfterInit.length}
First user must be created manually: âœ“`
            );

            // SUMMARY
            const allTests = document.querySelectorAll('.pass').length;
            const totalTests = document.querySelectorAll('.test').length;
            
            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 30px; padding: 15px; background: #f0f0f0; border-radius: 5px;';
            summary.innerHTML = `
                <h2>Summary: ${allTests}/${totalTests} Tests Passed</h2>
                ${allTests === totalTests ? 
                    '<p class="pass">âœ“ All security fixes are working correctly!</p>' : 
                    '<p class="fail">âœ— Some tests failed. Check details above.</p>'
                }
            `;
            results.appendChild(summary);

        } catch (error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'test fail';
            errorDiv.innerHTML = `
                <strong>ERROR during testing:</strong>
                <pre>${error.message}\n${error.stack}</pre>
            `;
            results.appendChild(errorDiv);
        }
    </script>
</body>
</html>
